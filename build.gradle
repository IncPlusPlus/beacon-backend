plugins {
    // https://stackoverflow.com/a/26240341/1687436
    id "com.diffplug.spotless" version "6.7.2" apply false
    // https://axion-release-plugin.readthedocs.io/en/latest/configuration/basic_usage/#multi-module-project
    id 'pl.allegro.tech.build.axion-release' version '1.13.6'
}

scmVersion {
    tag {
//        prefix = project.name
    }
//    versionIncrementer 'incrementMinorIfNotOnRelease'
}

subprojects {
    // https://axion-release-plugin.readthedocs.io/en/latest/configuration/basic_usage/#multi-module-project
    project.version = scmVersion.version
    apply plugin: 'com.diffplug.spotless'
    apply plugin: 'java'
    apply plugin: 'jacoco'

    ext {
        lombokVersion = '1.18.22'
    }

    spotless {
        java {
            toggleOffOn('@formatter:off', '@formatter:on')
            googleJavaFormat('1.13.0')
            // Avoid nitpicking the code generated by the OpenAPI Generator plugin
            targetExclude '**/generated/**'
            // the files to be formatted = (target - targetExclude)
            // NOTE: if target or targetExclude is called multiple times, only the
            // last call is effective
        }
    }

    jacocoTestCoverageVerification {
        // exclude generated classes from test coverage calculation
        afterEvaluate {
            getClassDirectories().setFrom(classDirectories.files.collect {
                fileTree(dir: it, exclude: [
                        'io/github/incplusplus/beacon/**/generated/**',
                        'io/github/incplusplus/beacon/**/mapper/**Impl**',
                ])
            })
        }
    }

    jacocoTestReport {
        // exclude generated classes from test coverage presentation
        afterEvaluate {
            getClassDirectories().setFrom(classDirectories.files.collect {
                fileTree(dir: it, exclude: [
                        'io/github/incplusplus/beacon/**/generated/**',
                        'io/github/incplusplus/beacon/**/mapper/**Impl**',
                ])
            })
        }
        reports {
            xml.required = true
            html.required = true
        }
    }

    check.dependsOn jacocoTestReport
}